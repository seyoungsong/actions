name: macos

# From: https://github.com/xiaoyifang/goldendict/blob/staged/.github/workflows/macos-6.x.yml

on:
  push:
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: macos-11 # https://github.com/actions/runner-images/blob/main/images/macos/macos-11-Readme.md
    steps:
      - name: Checkout (GoldenDict) # https://github.com/xiaoyifang/goldendict
        uses: actions/checkout@v3
        with:
          repository: xiaoyifang/goldendict
      - name: Install Qt # https://github.com/jurplel/install-qt-action
        run: |
          brew install qt
      - name: Build
        run: |
          brew uninstall opencc hunspell ffmpeg@5 ffmpeg@4 libtiff xz lzo libogg libvorbis zstd || true
          brew install create-dmg
          qmake CONFIG+=release CONFIG+=zim_support QMAKE_APPLE_DEVICE_ARCHS="x86_64 arm64" goldendict.pro
          make -j$(nproc)
      - name: Package
        run: |
          macdeployqt GoldenDict.app -qmldir=. -verbose=1
          codesign --force --deep -s - GoldenDict.app
          otool -L GoldenDict.app/Contents/MacOS/GoldenDict
          otool -L GoldenDict.app/Contents/Frameworks/lib*
          mkdir tmp
          mv GoldenDict.app ./tmp
          create-dmg --volname "GoldenDict Installer" --volicon "icons/macicon.icns" --window-pos 200 120 --window-size 800 400 --icon-size 100 --icon "GoldenDict.app" 200 190 --hide-extension "GoldenDict.app" --app-drop-link 600 185 --skip-jenkins "GoldenDict.dmg" tmp/
